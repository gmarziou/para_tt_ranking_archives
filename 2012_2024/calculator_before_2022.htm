<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ITTF PTT rating calculator</title>
    <script type="text/javascript">
        function valid_ratings(){ 
			var a=document.querySelector("#beforeRatingWinner").value;
			var b=document.querySelector("#beforeRatingLoser").value;
			var c=/[0-9]|./;
			if(a==""||b==""||a=="?"||b=="?"||!c.test(a)||!c.test(b)) { return false} 
			return true
		}
		
		function computeRatings(a) {
			if(valid_ratings()) { 	
				
				// Arrow animation
				document.querySelector("#rating-error").fadeOut("fast");
				document.querySelector(".winner-arrow:first").parent().insertAdjacentHTML("beforeend",document.querySelector(".winner-arrow:first").clone());
				document.querySelector(".winner-arrow:last").fadeOut("slow");
				document.querySelector(".loser-arrow:first").parent().insertAdjacentHTML("beforeend",document.querySelector(".loser-arrow:first").clone());
				document.querySelector(".loser-arrow:last").fadeOut("slow");
				
				var weight=computeWeight(Number(document.querySelector("#tournament").value),document.querySelector("#event").value);
				var beforeRatingWinner = Number(document.querySelector("#beforeRatingWinner").value);
				var beforeRatingLoser = Number(document.querySelector("#beforeRatingLoser").value);
				var e = beforeRatingWinner - beforeRatingLoser;
				var f = Math.ceil(weight * computeOutcomeWinner(e));
                var g = beforeRatingWinner + f;
                var h = "+" + f;
                f = computeOutcomeLoser(e);
                showRating("Winner", g, h);
				g = beforeRatingLoser - f;
				h = "-" + f;
				showRating("Loser",g,h);
			} else{
				document.querySelector("#rating-error").fadeIn("medium");
				return;
			}
		}
		
		function showRating(a,b,c) { 
			document.querySelector("#afterExplanation"+a).html(c);
			document.querySelector("#afterRating"+a).html(b)
		}
		function computeWeight(a,b) {
			if(a==1)return 1;
			if(b=="T") { 
				return a-.5 
			}
			return a 
		} 
		function computeOutcomeWinner(a) {
		    if (a >= 0) {
		        if (a < 25) { return 8 }
		        else if (a < 50) { return 7 }
		        else if (a < 100) { return 5 }
		        else if (a < 150) { return 3 }
		        else if (a < 200) { return 2 }
		        else if (a < 250) { return 1 }
		        else { return 1 }
		    }
		    else {
		        a = -a;
		        if (a < 25) { return 8 }
		        else if (a < 50) { return 10 }
		        else if (a < 100) { return 12 }
		        else if (a < 150) { return 15 }
		        else if (a < 200) { return 20 }
		        else if (a < 250) { return 26 }
		        else { return 32 }
		    }
		}
		function computeOutcomeLoser(a) {
		    if (a >= 0) {
		        if (a < 25) { return 8 }
		        else if (a < 50) { return 7 }
		        else if (a < 100) { return 5 }
		        else if (a < 150) { return 3 }
		        else if (a < 200) { return 2 }
		        else if (a < 250) { return 1 }
		        else { return 0 }
		    }
		    else {
		        a = -a;
		        if (a < 25) { return 8 }
		        else if (a < 50) { return 10 }
		        else if (a < 100) { return 12 }
		        else if (a < 150) { return 15 }
		        else if (a < 200) { return 20 }
		        else if (a < 250) { return 26 }
		        else { return 32 }
		    }
		}
		// Insert or takeaway the question marks on click
		document.querySelector(function(){ 
			document.querySelector(".rating input").live("focus",function(){
				if(document.querySelector(this).value=="?") {
					document.querySelector(this).value
				}
			})
		})
    </script>
</head>
<style type='text/css'>
<!--

body { margin: 10px; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; background-color: #fff; }
div, input { z-index: 1; }
h2 { padding: 0px; margin: 0px; }

.rating-area { min-height: 300px; }
#calculator { background-color: #EEE; padding-top: 10px; width: 500px; border: solid 1px #CCC; margin: 0 auto; position: relative; }
#player-info { width: 500px; }
#afterExplanationWinner, #afterExplanationLoser,
#afterRatingWinner, #afterRatingLoser { font-size: 27px; }
input  { width: 100px; font-weight: bold; font-size: 1.5em; }
.section { margin: 0px 10px 0px 10px; float: left; }
.clear, clear { clear: left; }
.centered { text-align: center; }
.half-block { width: 50%; float: left; margin: 10px 0px 5px 0px; font-weight: bold; position: relative ;}
.full-block { width: 100%; position: relateive; }
.compute-button { height: 40px; position: absolute; right: 190px; top: 200px;  width: 115px; }
.big-arrow { position: absolute; top: 62px; z-index: 0; opacity: .25; }
.winner-arrow { position: absolute; top: -2px; z-index: -1; opacity: .15; left: 51px; }
.winner-arrow .arrow-body { background-color: blue; }
.loser-arrow { position: absolute; top: -2px; z-index: -1; opacity: .15; left: 51px; }
.loser-arrow .arrow-body { background-color: red; }
.arrow-body { height: 125px; margin: 0 auto; position: relative; width: 75px; }
.arrow-tip { position: relative; font-size: 150px; top:-40px; }
.winner { color: blue; }
.loser { color: red; }
#rating-error { color: red; display: none; font-size: 14px; font-weight: bold; left: 186px; position: absolute; top: 112px; }
-->
</style>
<body>
    <div id='calculator' class='centered'>
		<div class='rating-area'>
			<div id="rating-error">&larr; Numbers only &rarr;</div>
			<h1 style='text-shadow: 0px -2px -3px #FFF;'>Rating Calculator</h1>
				
			<!-- *** Player info *** -->
		    <div class='half-block rating'>
				<div class='winner-arrow'>
					<div class='arrow-body'></div>
					<div class='winner arrow-tip'>&#9660;</div>
				</div>
			    <h2>Winner</h2>
			    <h3>Initial rating</h3>
                <input type="text" class="centered rating-input" id="beforeRatingWinner" value="?" maxlength="4" />
	        </div>
	        <div class='half-block rating'>
				<div class='loser-arrow'>
					<div class='arrow-body'></div>
					<div class='loser arrow-tip'>&#9660;</div>
				</div>
			    <h2>Loser</h2>
			    <h3>Initial rating</h3>
                <input type="text" class="centered rating-input" id="beforeRatingLoser" value="?" maxlength="4" />
	        </div>
			<div class='clear' />
		
			<!-- *** Match info *** -->
	        <div id="tournament-container" class='half-block'>
	            <label>
	                Tournament</label><br />
	            <select id="tournament" style="width: 130px">
	                <option value="1">Factor 20</option>
	                <option value="1.5">Factor 40</option>
					<option value="1.5">Championships</option>
	            </select>
	        </div>
	        <div id="event-container" class='half-block'>
	            <label>
	                Event</label></br/>
	            <select id="event">
	                <option value="S">Singles</option>
	                <option value="T">Team</option>
	            </select>
	        </div>
		

			<div class='clear'></div>
		
			<!-- *** Outcome explanation *** -->
			<div id="afterExplanationWinner" class='half-block'></div>
			<div id="afterExplanationLoser" class='half-block'></div>
			<div class='clear' style='margin-bottom: 50px'></div>
		
			<!-- *** Final ratings *** -->
			<div id="afterRatingWinner" class='half-block'></div>
			<div id="afterRatingLoser" class='half-block'></div>

			<div class='full-block'>
				<form>
					<input class='compute-button' type="button" onclick="computeRatings()" value="Compute" id="run" />
				</form>
			</div>
	    </div>
	</div>
    <div style='margin-top: 60px; text-align: left; padding: 5px'>
	    <hr style='opacity: 0.15; margin-bottom: 10px'/>
        <strong style='color:red'>Warning:</strong> Don&#39;t forget that players&#39; ratings are updated after each match. So winning against one player may not produce the same outcome at the beginning of a tournament or at its end.<br />
        <hr style='opacity: 0.15;  margin-bottom: 10px'/>
        <strong style='color:blue'>Tip:</strong> You don't need the Internet to use this calculator, once the page has been loaded in your browser you can use it offline as long as you don't close your browser.<br />
        Also, this page can be saved from your browser into a folder on your
        computer. Then, it can be executed offline by double clicking on the saved page.
    </div>
</body>
</html>